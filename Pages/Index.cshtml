@page
@model IndexModel
@{    
    ViewData["Title"] = "MySQLæ•°æ®åº“å‘½åè§„èŒƒæ£€æŸ¥å·¥å…·";
}

<div class="container mt-5">
    <div class="row justify-content-center">
        <div class="col-md-12">
            <div class="card shadow-lg">
                <div class="card-header bg-primary text-white text-center">
                    <h2 class="mb-0">ğŸ” MySQLæ•°æ®åº“å‘½åè§„èŒƒæ£€æŸ¥å·¥å…·</h2>
                </div>
                <div class="card-body">
                    <form method="post" class="space-y-4">
                        <div class="form-group">
                            <label for="connectionString" class="form-label font-weight-bold">æ•°æ®åº“è¿æ¥å­—ç¬¦ä¸²</label>
                            <input type="text" 
                                   class="form-control" 
                                   id="connectionString" 
                                   name="connectionString" 
                                   placeholder="Server=localhost;Database=test;Uid=root;Pwd=password;" 
                                   required 
                                   value="@Model.ConnectionString" />
                            <div class="form-text text-muted">è¯·è¾“å…¥æ‚¨çš„MySQLæ•°æ®åº“è¿æ¥å­—ç¬¦ä¸²</div>
                        </div>

                        <div class="form-group">
                            <label for="aiProvider" class="form-label font-weight-bold">AIæä¾›å•†</label>
                            <select 
                                class="form-control"
                                id="aiProvider"
                                name="aiProvider"
                                asp-for="AIProvider"
                                asp-items="Model.AIProviderOptions"
                                required>
                            </select>
                            <div class="form-text text-muted">é€‰æ‹©ä½¿ç”¨å“ªç§AIæœåŠ¡è¿›è¡Œå‘½åè§„èŒƒæ£€æŸ¥</div>
                        </div>

                        <div class="form-group">
                            <label for="namingRules" class="form-label font-weight-bold">å‘½åè§„èŒƒè§„åˆ™</label>
                            <textarea 
                                class="form-control" 
                                id="namingRules" 
                                name="namingRules" 
                                rows="10" 
                                required>
@Model.NamingRules</textarea>
                            <div class="form-text text-muted">å¯ä»¥è‡ªå®šä¹‰å‘½åè§„èŒƒè§„åˆ™</div>
                        </div>

                        <button type="button" id="checkButton" class="btn btn-primary w-100 py-2">
                                    <i class="fas fa-check-circle"></i> å¼€å§‹æ£€æŸ¥
                                </button>
                                
                                <!-- åŠ è½½çŠ¶æ€æŒ‡ç¤ºå™¨ -->
                                <div id="loadingIndicator" class="text-center mt-3" style="display: none;">
                                    <div class="spinner-border text-primary" role="status">
                                        <span class="sr-only">å¤„ç†ä¸­...</span>
                                    </div>
                                    <p class="mt-2">æ­£åœ¨åˆ†ææ•°æ®åº“å‘½åè§„èŒƒï¼Œè¯·ç¨å€™...</p>
                                </div>
                                
                                <script>
                                    document.addEventListener('DOMContentLoaded', function() {
                                        const checkButton = document.getElementById('checkButton');
                                        const loadingIndicator = document.getElementById('loadingIndicator');
                                        const reportContainer = document.getElementById('reportContainer');
                                        const errorMessage = document.getElementById('errorMessage');
                                        
                                        checkButton.addEventListener('click', function() {
                                            // æ˜¾ç¤ºåŠ è½½æŒ‡ç¤ºå™¨
                                            loadingIndicator.style.display = 'block';
                                            // ç¦ç”¨æŒ‰é’®
                                            checkButton.disabled = true;
                                            // éšè—ä¹‹å‰çš„æŠ¥å‘Šå’Œé”™è¯¯ä¿¡æ¯
                                            if (reportContainer) reportContainer.style.display = 'none';
                                            if (errorMessage) errorMessage.style.display = 'none';
                                            
                                            // è·å–è¡¨å•æ•°æ® - æ·»åŠ ç©ºå€¼æ£€æŸ¥
                                            const formData = new FormData();
                                            
                                            // ä½¿ç”¨å°å†™IDåŒ¹é…HTMLä¸­çš„å®é™…å…ƒç´ 
                                            const connectionStringElement = document.getElementById('connectionString');
                                            if (connectionStringElement) {
                                                formData.append('ConnectionString', connectionStringElement.value);
                                            }
                                            
                                            const namingRulesElement = document.getElementById('namingRules');
                                            if (namingRulesElement) {
                                                formData.append('NamingRules', namingRulesElement.value);
                                            }
                                            
                                            const aiProviderElement = document.getElementById('aiProvider');
                                            if (aiProviderElement) {
                                                formData.append('AIProvider', aiProviderElement.value);
                                            }
                                            
                                            // è·å–éªŒè¯ä»¤ç‰Œï¼Œå¦‚æœå­˜åœ¨çš„è¯
                                            let token = '';
                                            const tokenElement = document.querySelector('input[name="__RequestVerificationToken"]');
                                            if (tokenElement) {
                                                token = tokenElement.value;
                                            }
                                            
                                            // å‘é€AJAXè¯·æ±‚åˆ°Jsonå¤„ç†å™¨
                                            const requestOptions = {
                                                method: 'POST',
                                                body: formData
                                            };
                                            
                                            // åªæœ‰å½“ä»¤ç‰Œå­˜åœ¨æ—¶æ‰æ·»åŠ åˆ°è¯·æ±‚å¤´
                                            if (token) {
                                                requestOptions.headers = {
                                                    'RequestVerificationToken': token
                                                };
                                            }
                                            
                                            fetch('/Index?handler=Json', requestOptions)
                                            .then(response => response.json())
                                            .then(data => {
                                                // éšè—åŠ è½½æŒ‡ç¤ºå™¨
                                                loadingIndicator.style.display = 'none';
                                                // å¯ç”¨æŒ‰é’®
                                                checkButton.disabled = false;
                                                
                                                if (data.success) {
                                                    // æ›´æ–°æŠ¥å‘Šå†…å®¹
                                                    if (reportContainer) {
                                                        reportContainer.innerHTML = data.reportHtml;
                                                        reportContainer.style.display = 'block';
                                                    }
                                                } else {
                                                    // æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
                                                    if (errorMessage) {
                                                        errorMessage.textContent = data.error;
                                                        errorMessage.style.display = 'block';
                                                    }
                                                }
                                            })
                                            .catch(error => {
                                                // å¤„ç†è¯·æ±‚é”™è¯¯
                                                loadingIndicator.style.display = 'none';
                                                checkButton.disabled = false;
                                                if (errorMessage) {
                                                    errorMessage.textContent = 'è¯·æ±‚å¤±è´¥: ' + error.message;
                                                    errorMessage.style.display = 'block';
                                                }
                                            });
                                        });
                                    });
                                </script>
                    </form>
                    
                    <!-- é”™è¯¯æ¶ˆæ¯å®¹å™¨ -->
                    <div id="errorMessage" class="alert alert-danger mt-4" style="display: none;"></div>
                    
                    <!-- æŠ¥å‘Šå®¹å™¨ -->
                    <div id="reportContainer" class="mt-5" style="display: none;">
                        <!-- æŠ¥å‘Šå†…å®¹å°†é€šè¿‡AJAXåŠ¨æ€åŠ è½½ -->
                    </div>
                    
                    @if (!ModelState.IsValid)
                    {
                        <div class="mt-3 alert alert-danger">
                            @Html.ValidationSummary()
                        </div>
                    }
                </div>
            </div>

            @if (!string.IsNullOrEmpty(Model.ReportHtml))
            {
                <div class="mt-5 card shadow-lg">
                    <div class="card-header bg-success text-white">
                        <h3 class="mb-0">ğŸ“Š æ£€æŸ¥ç»“æœæŠ¥å‘Š</h3>
                    </div>
                    <div class="card-body">
                        <div class="overflow-auto" style="max-height: 600px;">
                            @Html.Raw(Model.ReportHtml)
                        </div>
                        <div class="mt-4 d-flex justify-content-between">
                            <a href="javascript:void(0)" onclick="window.print()" class="btn btn-outline-secondary">
                                <i class="fas fa-print"></i> æ‰“å°æŠ¥å‘Š
                            </a>
                            <a href="data:text/markdown;charset=utf-8,%E2%80%8B@Model.ReportMarkdown" 
                               download="DatabaseNamingReport_@(DateTime.Now.ToString("yyyyMMdd_HHmmss")).md" 
                               class="btn btn-outline-primary">
                                <i class="fas fa-download"></i> ä¸‹è½½MarkdownæŠ¥å‘Š
                            </a>
                        </div>
                    </div>
                </div>
            }
        </div>
    </div>
</div>

@section Scripts {
    <style>
        .markdown-body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, Arial, sans-serif;
            font-size: 16px;
            line-height: 1.6;
            word-wrap: break-word;
        }
        
        .markdown-body h1, .markdown-body h2, .markdown-body h3 {
            border-bottom: 1px solid #eaecef;
            padding-bottom: 0.3em;
        }
        
        .markdown-body pre {
            background-color: #f6f8fa;
            border-radius: 3px;
            padding: 16px;
            overflow: auto;
            font-family: SFMono-Regular, Consolas, Liberation Mono, Menlo, monospace;
            font-size: 14px;
        }
        
        .markdown-body code {
            font-family: SFMono-Regular, Consolas, Liberation Mono, Menlo, monospace;
            background-color: #f3f4f6;
            border-radius: 3px;
            padding: 0.2em 0.4em;
            font-size: 85%;
        }
        
        .markdown-body table {
            border-collapse: collapse;
            width: 100%;
            margin-bottom: 16px;
        }
        
        .markdown-body table th, .markdown-body table td {
            border: 1px solid #dfe2e5;
            padding: 6px 13px;
        }
        
        .markdown-body table tr {
            background-color: #fff;
            border-top: 1px solid #c6cbd1;
        }
        
        .markdown-body table tr:nth-child(2n) {
            background-color: #f6f8fa;
        }
    </style>
}